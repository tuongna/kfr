<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Firebase Sync Demo</title>
  </head>
  <body>
    <h1>Đăng nhập</h1>
    <p><i>Hãy đăng nhập để đồng bộ tiến độ học tập của bạn nhé</i></p>

    <button id="loginBtn">Click để đăng nhập</button>
    <p id="greeting" style="display: none"></p>
    <button id="syncBtn" style="display: none">Click để đồng bộ</button>
    <a id="homeLink" href="/index.html" style="display: none">Về bài học</a>
    <button id="logoutBtn" style="display: none">Đăng xuất</button>

    <pre id="output"></pre>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

      // Firebase config
      const firebaseConfig = {
        apiKey: 'AIzaSyDRmX1Eslwgarbsh0qsLI9UKle5QmNmpqQ',
        authDomain: 'kfrean.firebaseapp.com',
        projectId: 'kfrean',
        storageBucket: 'kfrean.firebasestorage.app',
        messagingSenderId: '225788695153',
        appId: '1:225788695153:web:7ac6bc58dd32c3e0c301d0',
        measurementId: 'G-X4NV041SNB',
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();
      const db = getFirestore(app);

      const loginBtn = document.getElementById('loginBtn');
      const greeting = document.getElementById('greeting');
      const syncBtn = document.getElementById('syncBtn');
      const homeLink = document.getElementById('homeLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const output = document.getElementById('output');

      // ===== Helper =====
      function saveLocal(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }
      function loadLocal(key) {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }
      function isNonEmpty(obj) {
        return obj && Object.keys(obj).length > 0;
      }

      async function fetchRemoteAndApply(user) {
        const progressRef = doc(db, 'users', user.uid, 'progress', 'main');
        const snap = await getDoc(progressRef);

        if (snap.exists()) {
          const data = snap.data() || {};
          const remote = {
            learnedVocab: data.learnedVocab || {},
            learnedSentences: data.learnedSentences || {},
          };

          if (isNonEmpty(remote.learnedVocab)) saveLocal('learnedVocab', remote.learnedVocab);
          if (isNonEmpty(remote.learnedSentences))
            saveLocal('learnedSentences', remote.learnedSentences);

          return remote;
        } else {
          await setDoc(progressRef, {
            learnedVocab: {},
            learnedSentences: {},
            createdAt: new Date().toISOString(),
          });
          return { learnedVocab: {}, learnedSentences: {} };
        }
      }

      async function mergeAndSync(userId, localKey, fbField) {
        const localData = loadLocal(localKey) || {};
        const progressRef = doc(db, 'users', userId, 'progress', 'main');
        const snap = await getDoc(progressRef);

        let fbData = {};
        if (snap.exists()) {
          fbData = snap.data()[fbField] || {};
        }

        const merged = { ...fbData };
        for (const k in localData) {
          if (!merged[k] || localData[k].xp > merged[k].xp) {
            merged[k] = localData[k];
          }
        }

        saveLocal(localKey, merged);
        await setDoc(progressRef, { [fbField]: merged }, { merge: true });

        return merged;
      }

      // ===== Login =====
      loginBtn.addEventListener('click', async () => {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          console.error('Login error:', e);
        }
      });

      // ===== Logout =====
      logoutBtn.addEventListener('click', async () => {
        try {
          await signOut(auth);
        } catch (e) {
          console.error('Logout error:', e);
        }
      });

      // ===== Auth state =====
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // reset UI
          loginBtn.style.display = '';
          greeting.style.display = 'none';
          syncBtn.style.display = 'none';
          homeLink.style.display = 'none';
          logoutBtn.style.display = 'none';
          output.textContent = '';
          return;
        }

        // Ẩn nút login, hiện câu chào, logout
        loginBtn.style.display = 'none';
        greeting.style.display = '';
        greeting.textContent = `Xin chào, ${user.displayName}!`;
        logoutBtn.style.display = '';

        // Tạo doc metadata nếu chưa có
        const userDocRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userDocRef);
        if (!snap.exists()) {
          await setDoc(userDocRef, {
            email: user.email,
            name: user.displayName,
            avatar: user.photoURL,
            createdAt: new Date().toISOString(),
          });
        }

        const remote = await fetchRemoteAndApply(user);

        const localVocab = loadLocal('learnedVocab') || {};
        const localSent = loadLocal('learnedSentences') || {};

        const remoteHasVocab = isNonEmpty(remote.learnedVocab);
        const remoteHasSent = isNonEmpty(remote.learnedSentences);

        if (
          (isNonEmpty(localVocab) && !remoteHasVocab) ||
          (isNonEmpty(localSent) && !remoteHasSent)
        ) {
          syncBtn.style.display = '';
        } else {
          syncBtn.style.display = 'none';
          if (remoteHasVocab || remoteHasSent) homeLink.style.display = '';
        }
      });

      // ===== Sync =====
      syncBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return alert('Please login first!');

        const vocab = await mergeAndSync(user.uid, 'learnedVocab', 'learnedVocab');
        const sent = await mergeAndSync(user.uid, 'learnedSentences', 'learnedSentences');

        output.textContent = 'Synced!\n' + JSON.stringify({ vocab, sent }, null, 2);
        syncBtn.style.display = 'none';
        homeLink.style.display = '';
      });
    </script>
  </body>
</html>
